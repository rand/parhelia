# Parhelia E2E Modal Integration Tests
# Validates the full execution pipeline on Modal
#
# Test levels:
# - smoke: Health check, volume verification, Claude binary presence (~30s)
# - core: Sandbox creation, simple prompt execution (~2-3 min)
# - full: Complete task lifecycle, checkpoints (~10-15 min)
#
# Cost estimates:
# - smoke: ~$0.02/run
# - core: ~$0.10/run
# - full: ~$0.50/run

name: E2E Modal Tests

on:
  schedule:
    # Daily at 4am UTC
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test level to run'
        type: choice
        options:
          - smoke
          - core
          - full
        default: core
  pull_request:
    paths:
      - 'src/parhelia/modal_app.py'
      - 'src/parhelia/dispatch.py'
      - 'src/parhelia/scripts/**'

env:
  MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
  MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

jobs:
  e2e-tests:
    name: E2E Tests (${{ inputs.test_level || 'core' }})
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Install Modal CLI
        run: uv pip install modal

      - name: Authenticate with Modal
        run: |
          uv run modal token set --token-id "$MODAL_TOKEN_ID" --token-secret "$MODAL_TOKEN_SECRET"

      - name: Determine test level
        id: level
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "level=smoke" >> $GITHUB_OUTPUT
          elif [ -n "${{ inputs.test_level }}" ]; then
            echo "level=${{ inputs.test_level }}" >> $GITHUB_OUTPUT
          else
            echo "level=core" >> $GITHUB_OUTPUT
          fi

      - name: Run E2E tests
        run: |
          uv run python scripts/e2e_modal_tests.py --level ${{ steps.level.outputs.level }}

      - name: Create test summary
        if: always()
        run: |
          echo "## E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Level**: ${{ steps.level.outputs.level }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: failure() && github.event_name == 'schedule'

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ E2E Modal tests failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            The scheduled E2E Modal tests failed.

            **Workflow run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            **Test level**: core (scheduled)

            Please investigate the failure and fix any regressions.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ci-failure', 'e2e-test']
            });
